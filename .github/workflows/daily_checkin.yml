name: Altr Daily Auto Claim # 任务名称

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

permissions:
  contents: write # 授予工作流写入仓库内容的权限

jobs:
  build:
    runs-on: ubuntu-latest # 使用最新的 Ubuntu 服务器

    steps:
      - name: Checkout code
        uses: actions/checkout@v3 # 第一步：下载你的代码仓库

      - name: Set up Python
        uses: actions/setup-python@v4 # 第二步：安装 Python 环境
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: | # 第三步：安装依赖库
          python -m pip install --upgrade pip
          # 安装旧脚本的依赖（如果有的话）
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # 【重要】强制安装两个脚本都必须的 selenium 和 webdriver_manager
          pip install selenium webdriver_manager

      # ========================================================
      # 旧脚本区域 (Altr 自动签到)
      # ========================================================
      - name: Altr 自动签到
        env: 
          # 请在 GitHub Secrets 中添加 ALTR_ACCOUNTS
          ALTR_ACCOUNTS: ${{ secrets.ALTR_ACCOUNTS }}
        run: python -u Altr.py # -u 参数保证日志实时输出

      # ========================================================
      # 新脚本区域 (Zampto 自动续费)
      # ========================================================
     # - name: Zampto 自动续费
      #  env:
          # 读取你在 Secrets 里设置的 ZAMPTO_ACCOUNTS
      #    ZAMPTO_ACCOUNTS: ${{ secrets.ZAMPTO_ACCOUNTS }}
        # 运行新脚本，-u 参数保证日志实时输出
      #  run: python -u zampto.py

      # --- 新增的防暂停代码开始 ---
      - name: Commit time.txt to repo
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # 如果 time.txt 不存在，说明是第一次运行
          if [ ! -f time.txt ]; then
            echo "首次生成时间：$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
          else
            echo "$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
          fi
          
          git add time.txt
          
          # 如果有更改再提交
          if git diff --cached --quiet; then
            echo "无变化，无需提交"
          else
            git commit -m "⏱️ 更新时间文件: $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin HEAD:main
          fi
      # --- 新增的防暂停代码结束 ---

      # ========================================================
      # 【新增】上传调试文件步骤
      # 只有当 zampto.py 生成了截图或 html 文件时，这里才会上传
      # ========================================================
      - name: Upload Debug Files
        uses: actions/upload-artifact@v4  # 使用官方插件上传文件
        if: always()                      # 【关键】无论上面的脚本是否报错，这一步都会强制执行
        with:
          name: debug-screenshots         # 下载时的压缩包名字
          path: |                         # 指定要上传的文件模式
            *.png
            *.html
          retention-days: 3               # 文件只保留3天，节省空间
